# 授業進行案（80分）：GitHub Copilotで既存Djangoコードを安全に改善する

対象：Django基礎（models/views/templatesの概念）を触ったことがある学生  
目的：**“既存コードの不具合を再現→原因特定→安全に修正→テストで固定”** を Copilot で体験する

> この教材には意図的に危険な実装（生SQLの組み立て等）が含まれます。  
> 授業の目的は「攻撃する」ではなく、「危険な実装を見つけて安全に直す」です。

---

## 事前準備（先生側）
- VS Code + GitHub Copilot を有効化しておく
- Python（推奨 3.11+）、Git が入っていること
- 受講者は **ローカルでのみ実行**（外部公開しない）

---

## 今日のゴール（学生に最初に宣言）
1. 旧検索モード（`legacy=1`）で発生する **“落ちやすい検索”** を再現できる  
2. 旧検索を **ORMに置き換えて安全化**できる  
3. 一覧に **ページネーション**を入れてUXを改善できる  
4. 直した内容を **最低1本のテスト**で固定できる  

---

## ルール（Copilotの使い方）
- いきなり全部を書き換えない（**小さく変更 → 実行 → 次へ**）
- Copilotの提案は「必ず目で読む」  
- 変更の単位ごとにコミット（理想：1課題=1PR）

---

## タイムテーブル（80分）

### 0〜10分：導入 & 起動確認
**学生作業**
- 仮想環境作成 → 依存install → migrate → loaddata → runserver
- 一覧/詳細/作成/編集/削除を軽く触る

**先生の話すこと**
- この授業は「新規開発」ではなく「修理と改善」
- Copilotは“提案エンジン”、判断は人間

---

### 10〜25分：不具合① 旧検索（legacy=1）を“落ちる形で”再現
**学生作業**
1. 一覧で `legacy=1` をONにして検索してみる
2. 検索語に **シングルクォート `'`** を含めてみる（落ちる/挙動が崩れるのを確認）
3. `memos/views.py` を開いて旧検索の実装を読む（`Memo.objects.raw(sql)` の部分）

**観察ポイント**
- 旧検索は **ユーザー入力を文字列連結**してSQLを作っている
- “落ちる”は「安全に修正すべきサイン」

**Copilotへの指示例**
- 「`legacy=1` の検索実装を Django ORM のフィルタに置き換えて。振る舞い（title/bodyの部分一致）は維持したい」
- 「旧検索フラグ自体は残すが、実装は安全なものにする」

**チェック**
- `legacy=1` でも `'` を含む検索で落ちなくなる  
- 通常検索（legacyなし）も壊れていない

---

### 25〜45分：不具合② ページネーションを入れる（一覧が重い）
**学生作業**
1. fixtureが大量なので一覧が長い/重いのを確認
2. `memo_list` に Django `Paginator` を導入
3. テンプレ `memo_list.html` に「前へ/次へ」とページ番号を表示  
   - まずは **前/次だけ**でもOK

**Copilotへの指示例**
- 「`memo_list` に `Paginator` を追加して、1ページ20件にして。テンプレも更新してページ移動できるようにして」
- 「q/tag/sort/legacy のパラメータを保ったままページ送りしたい」

**チェック**
- 1ページ20件くらいで表示される
- 絞り込み（q/tag）をしてもページ送りができる

---

### 45〜60分：安全性の基本（404対応 / deleteをPOST限定）
**学生作業**
1. `Memo.objects.get(...)` を `get_object_or_404` に変更（detail/edit）
2. deleteは **POSTのみ**許可し、GETは 405 にする

**Copilotへの指示例**
- 「detail/edit を `get_object_or_404` に置き換えて、存在しないIDは404を返して」
- 「delete view を POST のみにして、GETは 405 を返して」

**チェック**
- 存在しないIDでアクセス → 404
- GETでdelete URLを開いても削除されない（405）

---

### 60〜75分：テストを1〜2本追加して“直した証拠”を残す
**学生作業（優先順）**
1. deleteがGETで405、POSTで削除できる（view test）
2. detailが存在しないと404（view test）
3. 余裕があれば：ページネーションが効いている（contextや件数で確認）

**Copilotへの指示例**
- 「deleteがGETで405になるテストを書いて。POSTで削除されるテストも追加して」
- 「存在しないmemo_idでdetailが404になるテストを書いて」

**チェック**
- `python manage.py test` が通る
- 追加テストが落ちずに回る

---

### 75〜80分：まとめ（レビュー観点の共有）
- 今日の改善は「安全性」「UX」「テスト」の3本柱
- Copilotは早いが、**仕様の決定と最終判断は人間**
- 1PR=1目的の習慣（レビューしやすい）

---

## 追加課題（宿題/早く終わった人向け）
- `prefetch_related("tags")` を入れてN+1対策
- create/edit を Django Form に置き換える（バリデーションと重複削減）
- タグ処理（`attach_tags_from_csv`）の例外握りつぶしをやめ、責務を整理

---

## 先生向け：よくある詰まりポイント
- Paginator導入後、テンプレのリンクでGETパラメータが消える  
  → パラメータを引き継ぐ（`request.GET` を使う）工夫が必要
- raw() の返り値は制約がある  
  → 旧実装は残しても **中身はORM**にするのが無難

---

## PR/コミットのおすすめ分割
1. legacy検索の安全化
2. ページネーション導入
3. 404対応 & delete POST限定
4. テスト追加


参照：`BUG_CATALOG.md` に全改善ポイント（難易度付き）があります。


---

## 追加の“見つけやすいバグ”スイッチ
- `unsafe_sort=1`：sort値を order_by に直渡し（落ちやすい）→ 許可リスト方式へ
